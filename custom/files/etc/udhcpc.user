#!/bin/sh

[ -n "$interface" ] || exit

case "$1" in
	renew|bound)
		;;
	*)
		exit 0
		;;
esac

IF=1
while uci -q get network.if$IF; do
	[ "$(uci -q get network.if$IF.gateway)" = "$router" ] && exit 0
	IF=$((IF + 1))
done

WAN_MAC=$(uci -q get network.wan.macaddr)

uci -q batch << EOF
set network.if$IF=interface
set network.if$IF.ifname=$interface.$IF
set network.if$IF.interface=$interface
set network.if$IF.proto=static
set network.if$IF.ipaddr=$ip
set network.if$IF.netmask=${subnet:-255.255.255.0}
set network.if$IF.gateway=$router
set network.if$IF.dns=$dns
set network.if$IF.metric=$IF
set network.if$IF.multipath=on

set network.wan.macaddr=$(printf 42:42:AB:CD:EF:%02X "$IF")
set network.if$IF.macaddr=$WAN_MAC

commit network
EOF

ifup if$IF
ifup wan
